---
title: "Map data from INBO color ring database to crbirding (SOVON)"
author: 
- Damiano Oldoni
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: yeti
    df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("./docs/",sub(".Rmd", ".html", basename(input_file))))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Goal

This pipeline will:

1. extract data from INBO *kleurring* database (official name: `D0016_00_Meeuwen`)
2. transform data to SOVON format
3. export data in text files

# Setup

Load libraries:

```{r load_libraries}
library(DBI) # To connect to database
library(odbc) # To connect to database
library(stringr) # To perform string operations
library(stringi) # To perform string operations
library(readr) # To read and write txt files
library(dplyr) # To transform data
library(measurements) # To convert units of measurement 
library(here) # To find files
```

Set output file paths:

```{r file_paths}
cr_users_file <- here("data", "processed", "data_users.tsv")
cr_birds_file <- here("data", "processed", "data_birds.tsv")
cr_obs_file <- here("data", "processed", "data_observations.tsv")
```

# Extract data from INBO kleurring database

## Connection to INBO database

We establish a connection to the database. Sensible data are saved in the `.Renviron` file:

```{r connect_to_db}
conn <- dbConnect(odbc::odbc(),
                  driver = Sys.getenv("driver"),
                  server = Sys.getenv("server"),
                  database = Sys.getenv("database"),
                  port = Sys.getenv("port"),
                  trusted_connection = Sys.getenv("tc"))
```

## Extract data

### Extract user data

First, we extract data about users from INBO *kleurring* database:

```{r get_user_data}
users <-  dbGetQuery(conn, "SELECT * FROM dbo.tblWaarnemer") %>%
    as_tibble()
```

### Extract color ring data

```{r get_birds_data}
birds <- dbGetQuery(conn, "SELECT * FROM dbo.tblKleurring") %>%
  as_tibble()
```

### Extract observation data

INBO's observation data contain a text type field: `Opmerking`. Text type is deprecated and an error will be returned if we perform the standard SQL query `"SELECT * FROM dbo.tblWaarneming"`. So, we need an ad-hoc query:

```{r get_obs_data}
obs <- dbGetQuery(conn,
  "SELECT Nummer,
          Datum,
          EuringCode,
          LeeftijdCode,
          KleurringNummer,
          KleurringPlaats,
          MetaalringNummer,
          MetaalringPlaats,
          PlaatsGemeente,
          PlaatsToponym,
          PlaatsToponymDetail,
          Convert(nvarchar(4000),Opmerking) as Opmerking,
          WaarnemerNummer,
          PlaatsLengtegraadGraden,
          PlaatsLengtegraadMinuten,
          PlaatsLengtegraadSeconden,
          PlaatsBreedtegraadGraden,
          PlaatsBreedtegraadMinuten,
          PlaatsBreedtegraadSeconden,
          PlaatsLengtegraadRichtingCode,
          PlaatsBreedtegraadRichtingCode,
          PlaatsLandCode,
          MetaalringLandCode,
          BevestigingDatum,
          PlaatsProvincie,
          AanmaakDatum,
          WijzigDatum
  FROM dbo.tblWaarneming") %>% as_tibble()
```

Table `tblWaarnemingAktie` is also important because contains informations about the actions the observations refer to:

```{r get_waarnemingAktie}
obs_actions <- dbGetQuery(conn, "SELECT * FROM dbo.tblWaarnemingAktie")
```

The action codes are described in table `dbo.cdeAktie`:
```{r get_}
actions_meaning <- dbGetQuery(conn, "SELECT * FROM dbo.cdeAktie")
actions_meaning
```

## Pre-processing

Add prefix `raw_` to all column names to avoid any possible name clash with SOVON terms (for more info see [spreadsheet](https://docs.google.com/spreadsheets/d/16928bSQzZ0jz0FCf5gXZ4Rg4gf9qYQPO5izLZ5IYSTQ/edit?usp=drive_web&ouid=109004011205942623101) and [document](https://docs.google.com/document/d/1VtwGD4wrwJLnGnvJprtFB3MbbXdirMELYvuCGEhLr3w/edit)) as provided by SOVON (access restricted).

```{r add_raw}
colnames(users) <- paste0("raw_", colnames(users))
colnames(birds) <- paste0("raw_", colnames(birds))
colnames(obs) <- paste0("raw_", colnames(obs))
colnames(obs_actions) <- paste0("raw_", colnames(obs_actions))
```

For privcay reasons users data cannot be shown. Users data refer to the following fields:

```{r prview_users}
colnames(users)
```

Preview birds data:

```{r preview_birds}
birds %>% head()
```

Preview observations data:

```{r preview_obs}
obs %>% head()
```

Preview observation actions data:

```{r prview_obs_actions}
obs_actions %>% head()
```

The action acronym is contained in column  `raw_AktieCode`. Observations and their action are linked via columns `raw_WaarnemingNummer` (in `obs_actions`) and `raw_Nummer` (in `obs`).

No duplicates `raw_WaarnemingNummer`-`raw_AktieCode` should exist:

```{r show_duplicates_obs_actions}
obs_actions %>% filter(raw_WaarnemingNummer %in% 
                         (obs_actions %>% 
                         group_by(raw_WaarnemingNummer, 
                                  raw_AktieCode) %>% 
                         count() %>%
                         filter(n > 1) %>%
                         pull(raw_WaarnemingNummer)))
```

Otherwise they should be removed:

```{r to_be_removed_after}
# to be removed after cleaning by Marc!!!
obs_actions <- obs_actions %>% 
  distinct(raw_WaarnemingNummer, 
           raw_AktieCode, .keep_all = TRUE)
```

All observations should also have an action code:

```{r observations_without_action}
obs %>% 
  filter(!raw_Nummer %in% 
           (obs_actions %>% pull(raw_WaarnemingNummer)))
```

Observation without it will be removed:

```{r remove_observations_without_action}
obs <- obs %>% 
  filter(raw_Nummer %in% 
           (obs_actions %>% pull(raw_WaarnemingNummer)))
```

In order to ease the mapping of birds and observations, we add action codes to observations in order to have a unique **tidy** data frame:

```{r}
obs_and_acts <- obs %>% 
  left_join(obs_actions %>% 
              select(-c(raw_Nummer, 
                        raw_AanmaakDatum, 
                        raw_WijzigDatum)),
            by = c("raw_Nummer" = "raw_WaarnemingNummer"))
```

There are observations judged as error. They are marked by`raw_KleurringNummmer` equal to `FOUT`, which is also in `birds`. We remove both:

```{r remove_FOUT}
obs_and_acts <- obs_and_acts %>% filter(raw_KleurringNummer != "FOUT")
birds <- birds %>% filter(raw_Nummer != "FOUT")
```

Typically bird color rings codes are uppercase:

```{r show_example_Nummer_uppercase}
all(toupper(birds$raw_Nummer) == birds$raw_Nummer)
```

And so should be for `raw_KleurringNummer` in `obs_and_acts`. Exceptions:

```{r lowercase_raw_kleurringNummer}
obs_and_acts %>% 
  filter(raw_KleurringNummer != toupper(raw_KleurringNummer)) %>% 
  distinct(raw_KleurringNummer)
```

We transform all of them to uppercase:

```{r raw_KleurringNummer_to_upper}
obs_and_acts <- obs_and_acts %>% 
  mutate(raw_KleurringNummer = toupper(raw_KleurringNummer))
```

# Map data

We tranform the information extracted from INBO color ring database to SOVON format.

## Map user data

We start mapping user data.

### E-mail

```{r e-mail}
users <- users %>%
  mutate(user_email = raw_Email)
```

### First name

```{r first_name}
users <- users %>%
  mutate(user_first_name = raw_Voornaam)
```

### Last name

```{r last_name}
users <- users %>%
  mutate(user_last_name = raw_Familienaam)
```

### Address

```{r address}
users <- users %>%
  mutate(user_address = raw_Adres)
```

### Place

```{r place}
users <- users %>%
  mutate(user_place = raw_Gemeente)
```

### Postal code

```{r postal_code}
users <- users %>%
  mutate(user_postal_code = raw_Postcode)
```

### Country

```{r country}
users <- users %>%
  mutate(user_country = raw_LandCode)
```

### User ID

User identifiers are provided by SOVON. `NA` is given.

```{r userID}
users <- users %>%
  mutate(user_id  = NA)
```

### User reference

Field provided by SOVON: `NA` is given

```{r user_ref}
users <- users %>%
  mutate(user_reference  = NA)
```

### User language

This field is not present in `users`. However, all accounts have been made by INBO in Dutch:

```{r user_language}
users <- users %>%
  mutate(user_language  = "Dutch")
```

### User role

The distinction between ringer and observer is not present in `users`, but can be retrieved by combining it with `obs_and_acts`.

We filter by ring actions (`rngkl` or `rngme`) and we retrieve the ringers by `raw_WaarnemerNummer`:

```{r find_ringers}
ringers_number <- obs_and_acts %>% 
  filter(raw_AktieCode %in% c("rngkl","rngme")) %>%
  distinct(raw_WaarnemerNummer) %>% pull()
print(paste("Number of ringers:", 
            length(ringers_number)))
```

And we assign a `R` (ringer) to them, `O` (observer) otherwise:

```{r assign_ringer}
users <- users %>%
  mutate(user_role = ifelse(raw_Nummer %in% ringers_number,
                      "R", "O"))
```

## Map color ring data

### Euring

Present values:

```{r euring_in_db}
birds %>% distinct(raw_EuringCode)
```

We apply the following mapping:

```{r bird_euring}
birds <- birds %>%
  mutate(bird_euring = recode(raw_EuringCode,
                              "5920" = "05920",
                              "5910" = "05910",
                              "5926" = "05926",
                              "5922" = "05922",
                              "zz" = NA_character_,
                              "zzz" = NA_character_))
```

Effects of mapping:

```{r comparison_euring}
birds %>% distinct(raw_EuringCode, bird_euring)
```

### Short hand

```{r shorthand}
birds <- birds %>%
  mutate(bird_shorthand = raw_RingKleurCode)
```

### Scheme

Actual values:

```{r scheme}
birds %>% distinct(raw_MetaalringLandCode)
```

We apply the following mapping:

```{r scheme_mapping}
birds <- birds %>%
  mutate(bird_scheme = recode(raw_MetaalringLandCode,
                              "BE " = "BLB",
                              "FR" = "FRP",
                              "NL" = "NLA",
                              "PT" = "POL",
                              "UK" = "GBT"))
```

Effects of mapping:

```{r comparison_scheme}
birds %>% distinct(raw_MetaalringLandCode, bird_scheme)
```

### Ring number

The ring number can be found in field `raw_MetaalringNummer`. Ring number should consist of up to ten **alphanumeric** characters. At page 7 of the [EURING Exchange Code 2000+ document](https://euring.org/files/documents/E2000PLUSExchangeCodev1161.pdf) we read the following instructions:

> Where the ring number consist of fewer than ten numbers/letters, the number is padded with dots. These dots are always inserted to the left of the rightmost
row of numbers.

Ring number anomalies:

```{r anomalies_ring_number}
birds %>%
  filter(!str_detect(raw_MetaalringNummer, pattern = regex("\\d+"))) %>%
  group_by(raw_MetaalringNummer) %>%
  count()
```

Value `none` means _not metal-ringed bird_, while `onbekend` means that information is no more available. SOVON chooses to leave column `bird_ring_number` empty for both cases and adding a note in `bird_notes` column. Value `?` is equivalent to `onbekend` while `H????????` and `Lxxxxxx` are mapped as `H--------` and `L------` respectively.

```{r solve_anomalies_bird_ring_number}
birds <- birds %>%
  mutate(bird_ring_number = recode(raw_MetaalringNummer,
                              "?" = NA_character_,
                              "onbekend" = NA_character_,
                              "none" = NA_character_,
                              "H????????" = "H--------",
                              "Lxxxxxx" = "L------")) %>%
  mutate(bird_notes = case_when(
    raw_MetaalringNummer %in% c("?", "onbekend") ~ "bird_ring_number not anymore available.",
    raw_MetaalringNummer == "none" ~ "bird_ring_number not present."))
```

We separate the birds with special mapping values by all the others:

```{r hold_special_values}
special_values <- c("H--------", "L------")
birds_special_values <- birds %>%
  filter(bird_ring_number %in% special_values)
birds_others <- birds %>%
  filter(!bird_ring_number %in% special_values)
```

Some ring numbers contain asterisks:

```{r show_asterisks}
birds_others %>% 
  filter(str_detect(bird_ring_number, "\\*")) %>%
  select(bird_ring_number)
```

We remove all of them:

```{r remove_*_in_ring_number}
birds_others <- birds_others %>%
  mutate(bird_ring_number = gsub("\\*", "", bird_ring_number))
```

Add points `.` where needed:

```{r add_._in_ring_number}
birds_others <- birds_others %>%
  mutate(reversed = stri_reverse(str = bird_ring_number))
idx <- as.data.frame(str_locate(birds_others$reversed, pattern = regex("\\d+")))$end
idx <- replace_na(idx, 0)
birds_others <- birds_others %>%
  mutate(bird_ring_number = stri_reverse(str_c(
    str_sub(reversed, 
          end = idx),
  map_chr(nchar(reversed), function(x) {
    ifelse(x < 10,
           str_c(rep(".", 10 - x), collapse = ""),
           "")
  }),
  str_sub(reversed, 
          start = idx+1)))) %>%
  select(-reversed)
```

Merge the two data frames together:

```{r}
birds <- bind_rows(birds_others, birds_special_values)
```

Effects of mapping (part of it):

```{r}
birds %>% distinct(raw_MetaalringNummer, bird_ring_number)
```

### Bird sex

Bird sex is translated to English: `M` (mannetje) will not change so no need to convert it:

```{r sex}
birds <- birds %>%
  mutate(bird_sex = recode(raw_GeslachtCode,
    "V" = "F", # V(rouwtje) ->F(emale)
    "O" = "U" # O(nbekend) ->  U(nknown)
))
```

### Bird age ringing

Map the age of the bird while ringing. This information can be found in column `raw_LeeftijdCode` of data frame `obs` when related code action in `obs_actions` is equal to `rngkl` (code action of applying colour ring). Such age can then be added to data frame `birds` by matching the color ring number:

```{r retrieve_age_ringing}
birds <- left_join(obs_actions %>% 
                     select(raw_WaarnemingNummer, raw_AktieCode) %>%
                     filter(raw_AktieCode == "rngkl"), 
                   obs, 
                   by = c("raw_WaarnemingNummer" = "raw_Nummer")) %>%
  select(raw_WaarnemingNummer,
         raw_KleurringNummer,
         raw_LeeftijdCode) %>%
  right_join(birds, 
             by = c("raw_KleurringNummer" = "raw_Nummer"))
```

Mapping the age while applying color ring from INBO format to SOVON standard (Euring standard: see [online pdf document](https://euring.org/files/documents/E2000PLUSExchangeCodev1161.pdf) at page 14)

```{r}
birds <- birds %>%
  mutate(bird_age_ringing = recode(raw_LeeftijdCode,
    "PU" = "1",
    "AD" = "2",
    "J1" = "3",
    "I4" = "5",
    "I3" = "7",
    "I2" = "9",
    "I5" = "B",
    .missing = "O"))
```

### Bird ID

Bird identifiers will be provided by SOVON. `NA` is given:

```{r birdID}
birds <- birds %>%
  mutate(bird_id = NA)
```

### Bird BTO

Bird BTO will be provided by SOVON.  `NA` is given:

```{r bird_bto}
birds <- birds %>%
  mutate(bird_bto = NA)
```

### Bird name

Bird name will be provided by SOVON.  `NA` is given:

```{r bird_name}
birds <- birds %>%
  mutate(bird_name = NA)
```

### Bird birth year

This field will be filled by SOVON (authomatically by a function, I think). `NA` is given:

```{r bird_birth_year}
birds <- birds %>%
  mutate(bird_birth_year = NA)
```

### Bird date end

This field should be left to SOVON.  `NA` is given:

```{r bird_date_end}
birds <- birds %>%
  mutate(bird_date_end = NA)
```

## Map observation data

### Observation reference

```{r obs_ref}
obs <- obs %>% mutate(observation_reference = raw_Nummer)
```

### Observation date

```{r obs_date}
obs <- obs %>% mutate(observation_date = raw_Datum)
```

### Observation time

No time is found for observations in `obs`. `NA` is given:

```{r obs_time}
obs <- obs %>% mutate(observation_time = NA)
```

### Observation latitude

Observation latitude should be converted to decimal degrees:

```{r obs_latitude}
obs <- obs %>% mutate(
  observation_lat = conv_unit(
    str_c(raw_PlaatsBreedtegraadGraden,
          raw_PlaatsBreedtegraadMinuten,
          raw_PlaatsBreedtegraadSeconden, 
          sep = " "), 
    from = 'deg_min_sec', to = 'dec_deg'
))
```

### Observation longitude

Observation longitude should be converted to decimal degrees:

```{r obs_longitude}
obs <- obs %>% mutate(
  observation_long = conv_unit(
    str_c(raw_PlaatsLengtegraadGraden,
          raw_PlaatsLengtegraadMinuten,
          raw_PlaatsLengtegraadSeconden, 
          sep = " "), 
    from = 'deg_min_sec', to = 'dec_deg'
))
```

### Observation location

Aggregate information about observation location. We follow the following structure: `raw_PlaatsGemeente` [+ `, ` + `raw_PlaatsToponym` [+ `: ` + `raw_PlaatsToponymDetail`]]:

```{r}
obs <- obs %>% mutate(
  observation_location = ifelse(!is.na(raw_PlaatsToponym),
                                str_c(raw_PlaatsGemeente,
                                      raw_PlaatsToponym, 
                                      sep = ", "),
                                paste(raw_PlaatsGemeente))) %>%
  mutate(observation_location = ifelse(!is.na(raw_PlaatsToponymDetail),
                                       str_c(observation_location,
                                             raw_PlaatsToponymDetail,
                                             sep = ": "),
                                       paste(observation_location)))
```


### Observation notes

```{r obs_notes}
obs <- obs %>% mutate(observation_notes = raw_Opmerking)
```

### MRI: metal ring information

Metal ring information table can be found at page 8 of [this pdf document](https://euring.org/files/documents/E2000PLUSExchangeCodev1161.pdf)

A summary of the mapping follows:

1. observations with action code `meweg` should be mapped to 0 (metal ring is not present)

Further mapping steps need the knowledge of an expert.

```{r MRI}

```

# Post-processing

## User data 

Remove the original columns:

```{r user_remove_originals}
users <- users %>% select(-starts_with("raw_"))
```

Preview data:

```{r final_preview_users}
users %>% head()
```

Save to CSV:

```{r write_user_data_txt}
readr::write_csv(users, path = cr_users, na = "")
```

## Bird data

Remove the original columns:

```{r birds_remove_originals}
birds <- birds %>% select(-starts_with("raw_"))
```

Preview data:

```{r final_preview_birds}
birds %>% head()
```

Save to CSV:

```{r write_bird_data_txt}
readr::write_csv(birds, path = cr_birds, na = "")
```

## Observation data


Remove the original columns:

```{r obs_remove_originals}
obs <- obs %>% select(-starts_with("raw_"))
```

Preview data:

```{r final_preview_obs}
obs %>% head()
```

Save to CSV:

```{r write_obs_data_txt}
readr::write_csv(obs, path = cr_obs, na = "")
```
