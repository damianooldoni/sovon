# Goal

This pipeline will map user data.

# Read temporary user data

We start from the user tempoary data saved in TSV file `users.tsv` in folder `data\interim`:

```{r}
users <- read_tsv(here::here("data", "interim", "users.tsv"))
```

Number of users:

```{r}
nrow(users)
```

# Map user data

We map the original fields to SOVON fields.

## E-mail

```{r e-mail}
users <- 
  users %>%
  mutate(sovon_user_email = Email)
```

## First name

```{r first_name}
users <- 
  users %>%
  mutate(sovon_user_first_name = Voornaam)
```

## Last name

```{r last_name}
users <- 
  users %>%
  mutate(sovon_user_last_name = Familienaam)
```

## Address

```{r address}
users <- 
  users %>%
  mutate(sovon_user_address = Adres)
```

## Place

```{r place}
users <- 
  users %>%
  mutate(sovon_user_place = Gemeente)
```

## Postal code

```{r postal_code}
users <- 
  users %>%
  mutate(sovon_user_postal_code = Postcode)
```

## Country

```{r country}
users <- 
  users %>%
  mutate(sovon_user_country = LandCode)
```

## User ID

User identifiers are provided by SOVON. `NA` is given.

```{r userID}
users <- 
  users %>%
  mutate(sovon_user_id  = NA)
```

## User reference

We use the unique ID in `Nummer`:

```{r user_ref}
users <- 
  users %>%
  mutate(sovon_user_reference  = Nummer)
```

## User language

This field is not present in `users`. However, all accounts have been made by INBO in Dutch:

```{r user_language}
users <- 
  users %>%
  mutate(sovon_user_language  = "Dutch")
```

# Create `crbirding_users`

Export the SOVON fields to `crbirding_users`:

```{r make_crbirding_users}
crbirding_users <- 
  users %>%
  select(starts_with("sovon_"))
```

Remove prefix `sovon_`:

```{r remove prefix_sovon}
names(crbirding_users) <- str_remove_all(
  names(crbirding_users), 
  pattern = "sovon_"
)
```

The desired order of columns in `crbirding_users`:

```{r cols_order_users}
cr_users_cols <- c(
  "user_id", "user_reference", "user_email", "user_first_name",
  "user_last_name", "user_address", "user_postal_code", "user_place",
  "user_country", "user_language", "user_role"
)
```

Fields still not mapped:

```{r check_presence_required_cols_users}
cr_users_cols[which(!cr_users_cols%in% names(crbirding_users))]
```

The field `user_role` cannot be filled ath the moment: it will be mapped at the end of `3_birds.Rmd`.

Set column order:

```{r get_right_order_cols_users}
crbirding_users <-
  crbirding_users %>%
  select(cr_users_cols[cr_users_cols != "user_role"])
```

Preview data (e-mail, first and last names removed for privacy reasons):

```{r final_preview_users}
crbirding_users %>%
  select(-c(user_email, user_first_name, user_last_name)) %>%
  head(n = 10)
```

Save to TSV file `crbirding_users.tsv` in `./data/processed/`:

```{r write_user_data_txt}
crbirding_users %>%
  write_tsv(
    path = here::here("data", "processed", "crbirding_users.tsv"), 
    na = ""
)
```
