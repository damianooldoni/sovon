# Map observation data

## Read data

### Read temporary observation data

We start from the tempoary observation data saved as TSV file in `data\interim`:

```{r import_temp_observations}
obs_and_acts <- read_tsv(
  here::here("data", "interim", "obs_and_actions.tsv"), 
  guess_max = 500000
)
```

### Read action data

Import action codes and relative meaning:

```{r import_actions_meaning2}
actions_meaning <- read_tsv(here::here("data", "input", "actions_meaning.tsv"))
```

### Read processed ring data

We import finalized ring data from `./data/processed`:

```{r import_final_ring_data}
crbirding_birds <- read_tsv(
  here::here("data", "processed", "crbirding_birds.tsv"), 
  guess_max = 50000
)
```

### Read temporary ring data

We will need some columns from original INBO ring data. We import the temporary ring data as well:

```{r import_birds_from_INBO_temp_data}
birds <- read_tsv(
  here::here("data", "interim", "birds.tsv"), 
  guess_max = 50000
)
```

### Read processed user data

We import finalized user data from `./data/processed`:

```{r import_final_user_data}
crbirding_users <- read_tsv(
  here::here("data", "processed", "crbirding_users.tsv"), 
  guess_max = 50000
)
```

### Read list workers in bird shelters

```{r import_workers}
workers_bird_shelters <- read_tsv(
  here::here("data", "input", "workers_in_bird_shelters.tsv")
)
```

## Map color observation data

### Extract action codes

Actions present in `obs_and_acts` :

```{r}
acts <- actions_meaning$Code
acts <- acts[acts %in% names(obs_and_acts)]
acts
```

### Observation ID

The field `sovon_observation_id` is left to SOVON:

```{r add_obs_id}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_observation_id = NA)
```

### Observation reference

The observation reference is an unique identifier assigned to each observation. This field exists already: `Nummer`.

```{r add_obs_ref}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(sovon_observation_reference = Nummer)
```

### Observation date

The date is saved in column `Datum`. We copy it in required column `sovon_observation_date`:

```{r obs_date}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(sovon_observation_date = Datum)
```

### Observation time

There is no observation time in `obs_and_acts`. `NA` is given to `sovon_observation_time`:

```{r obs_time}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(sovon_observation_time = NA)
```

### Observation latitude

Observation latitude should be converted to decimal degrees:

```{r obs_latitude}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(
    sovon_observation_lat = conv_unit(
      str_c(PlaatsBreedtegraadGraden,
            PlaatsBreedtegraadMinuten,
            PlaatsBreedtegraadSeconden, 
            sep = " "), 
      from = 'deg_min_sec', to = 'dec_deg')
)
```

### Observation longitude

Observation longitude should be converted to decimal degrees:

```{r obs_longitude}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(
    sovon_observation_lng = conv_unit(
      str_c(PlaatsLengtegraadGraden,
            PlaatsLengtegraadMinuten,
            PlaatsLengtegraadSeconden, 
            sep = " "), 
      from = 'deg_min_sec', to = 'dec_deg')
)
```

### Observation location

Aggregate information about observation location. We follow the following structure: `PlaatsGemeente` [+ `, ` + `PlaatsToponym` [+ `: ` + `PlaatsToponymDetail`]]:

```{r obs_location}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(
    sovon_observation_location = ifelse(!is.na(PlaatsToponym),
                                  str_c(PlaatsGemeente,
                                        PlaatsToponym, 
                                        sep = ", "),
                                  paste(PlaatsGemeente))) %>%
  mutate(
    sovon_observation_location = ifelse(!is.na(PlaatsToponymDetail),
                                  str_c(sovon_observation_location,
                                        PlaatsToponymDetail,
                                        sep = ": "),
                                  paste(sovon_observation_location)))
```

### Check bird

The field `sovon_check_bird` is provided by SOVON. `NA` is given:

```{r check_bird}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_check_bird = NA)
```

### User ID

The field `sovon_user_id` is left to SOVON:

```{r add_user_id}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_user_id = NA)
```


### User reference

The field `sovon_user_reference` links observations to users and it is equal to field `user_reference` in user data:

```{r add_user_reference}
obs_and_acts <-
  obs_and_acts %>%
  mutate(sovon_user_reference = WaarnemerNummer)
```

### Observer

The field `sovon_melder` is equal to `user_first_name` and `user_last_name` in `users`:

```{r obs_sovon_melder}
obs_and_acts <- 
  obs_and_acts %>%
  left_join(
    crbirding_users %>% 
      select(user_reference, user_first_name, user_last_name),
    by = c("WaarnemerNummer" = "user_reference")) %>%
  mutate(sovon_melder = case_when(
    is.na(user_first_name) & !is.na(user_last_name) ~ user_last_name,
    !is.na(user_first_name) & is.na(user_last_name) ~ user_first_name,
    !is.na(user_first_name) & !is.na(user_last_name) ~ str_c(user_first_name, user_last_name, sep = " "),
    is.na(user_first_name) & is.na(user_last_name) ~ NA_character_)) %>%
  select(-c(user_first_name, user_last_name))
```

### Observer e-mail

The field `sovon_melder_email` is equal to `user_email` in `users`:

```{r obs_sovon_melder_email}
obs_and_acts <- 
  obs_and_acts %>%
  left_join(
    crbirding_users %>% 
      select(user_reference, user_email),
    by = c("WaarnemerNummer" = "user_reference")) %>%
  mutate(sovon_melder_email = user_email)
```

### Reporter - ringer number

The field `sovon_melder_ringersnummer` is left to SOVON:

```{r sovon_melder_ringersnummer}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_melder_ringersnummer = NA)
```

### Ring number

The field `sovon_ring_number` contains information about the metal ring number, in the same format as in field `bird_ring_number` of `crbirding_birds`. As explained in the mapping of field `bird_ring_number` of `crbirding_birds`, INBO database is a color ring database. This field is not accurately mapped and we will leave it empty.

```{r add_ring_number}
obs_and_acts <-
  obs_and_acts %>%
  mutate(sovon_ring_number = NA_character_)
```

### Observation status

Adding the EURING status information arises by the need of mapping the observations with action code `br` and `vang`:

```{r breed_show}
actions_meaning %>%
  filter(Code %in% c("br", "vang"))
```

The actions `br` and `vang` refer to status `breeding` in EURING system. Based on the scheme at page 16 of [EURING Exchange Code 2000+](https://euring.org/files/documents/E2000PLUSExchangeCodev1161.pdf) document, we define the following mapping:

```{r obs_status}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_status = case_when(
    !is.na(br) | !is.na(vang) ~ "N",
    LeeftijdCode == "PU" ~ "-",
    TRUE ~ "U"
  ))
```

### Condition

The SOVON field `condition` is mapped following the scheme at page 22 of [EURING Exchange Code 2000+](https://euring.org/files/documents/E2000PLUSExchangeCodev1161.pdf) document. The following actions are mapped as follows in order of priority:

1. `dood`: condition = 1
2. `ziek`: condition = 4
3. `rngkl`, `rngme`, `vang`, `vangl`: condition = 8
4. `veld`, `me`, `meweg`, `br`: condition = 7

```{r obs_condition}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_condition = case_when(
    !is.na(dood) ~ 1,
    !is.na(ziek) ~ 4,
    !is.na(rngkl) | !is.na(rngme) | !is.na(vang) | !is.na(vangl)  ~ 8,
    !is.na(veld) | !is.na(me) | !is.na(meweg) | !is.na(br)  ~ 7
    )
)
```

The observations of sick birds not anymore released should get condition equal to 5. These observations are linked to the very last `ziek` action and followed by an observation with action `dood`. Not only, but the observer should be a worker of a bird shelter, in `workers_bird_shelters`.

Reference number of observations with condition 5:

```{r get_obs_cond_5}
last_sick_df <- 
  obs_and_acts %>%
  filter(sovon_melder_ringersnummer %in% workers_bird_shelters$user_reference) %>%
  filter(ziek == "ziek") %>%
  group_by(sovon_bird_reference) %>%
  filter(sovon_observation_date == max(sovon_observation_date)) %>%
  ungroup() %>%
  select(sovon_observation_reference, sovon_bird_reference, sovon_observation_date) %>%
  rename(last_sick_date = sovon_observation_date,
         obs_ref = sovon_observation_reference)
dead_df <-
  obs_and_acts %>%
  filter(dood == "dood") %>%
  select(sovon_bird_reference, sovon_observation_date) %>%
  rename(dead_date = sovon_observation_date)
last_sick_df <- 
  last_sick_df %>%
  filter(sovon_bird_reference %in% dead_df$sovon_bird_reference) %>%
  left_join(dead_df, by = "sovon_bird_reference")

condition_5_obs_ref <- 
  obs_and_acts %>%
  filter(sovon_bird_reference %in% last_sick_df$sovon_bird_reference) %>%
  left_join(last_sick_df,
            by = "sovon_bird_reference") %>%
  group_by(sovon_bird_reference) %>%
  filter(sovon_observation_date >= last_sick_date & 
           sovon_observation_date < dead_date) %>%
  count() %>%
  ## only one ziek action present -> no obs possible if not released
  filter(n == 1) %>%
  left_join(last_sick_df,
            by = c("sovon_bird_reference")) %>%
  pull(obs_ref)
```

Number of observations selected to get condition code 5:

```{r n_obs_condition_5}
length(condition_5_obs_ref)
```

Assign condition value `5` to these observations:

```{r assign_5}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_condition = 
           if_else(
             sovon_observation_reference %in% condition_5_obs_ref, 
             5,
             sovon_condition)
)
```

Preview:

```{r preview}
obs_and_acts %>%
  filter(sovon_condition == 5) %>%
  select(sovon_observation_reference, 
         sovon_bird_reference, 
         sovon_observation_date,
         acts)
```

### MRI: metal ring information

Metal ring information is an integer between 0 and 9. A table can be found at page 8 of [EURING Exchange Code 2000+](https://euring.org/files/documents/E2000PLUSExchangeCodev1161.pdf) document.

However, SOVON uses this field to map the observations referring to the applying of any kind of ring, either color or metal, as their database is purely focussed on color rings and due to a missing field in the EURING Exchange Code 2000+ specific for color rings.

Some actions are related to this field and are mapped as follows: 

1. `rngkl`: MRI = 1 
2. `rngme`: MRI = 1
3. `veld`: MRI = 4, 
4. `me`: MRI = 4, 
5. `vang` : MRI = 1,4 or 5
6. `vangl` : MRI = 1,4 or 5

We initialize `sovon_MRI` as an empty column:

```{r intialize_MRI}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_MRI = NA_integer_)
```

Position of metal ring:

```{r}
birds %>% 
  distinct(MetaalringPlaats)
```

where `LL` means *left leg* and  `RL` means *right leg*. So, we exclude MRI values 2, *Metal ring added, definitely on tarsus*, and 3, *Metal ring added, definitely above tarsus*.

All observations linked to `rngme` or `rngkl` get MRI equal to 1:

```{r set_MRI_1}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_MRI = ifelse(!is.na(rngme) | !is.na(rngkl), 1, sovon_MRI))
```

Preview of changes:

```{r preview_changes_MRI_1}
obs_and_acts %>%
  filter(sovon_MRI == 1) %>%
  select(sovon_observation_reference, sovon_MRI, rngme, rngkl) %>%
  head(n = 50)
```

MRI is 4 for observations linked to action `me` (metal ring read) and `veld` (field observation, equivalent of color ring read):

```{r MRI_4_me_veld}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_MRI = ifelse(!is.na(me) | !is.na(veld), 4, sovon_MRI))
```

Preview of changes:

```{r preview_changes_MRI_4}
obs_and_acts %>%
  filter(sovon_MRI == 4) %>%
  select(sovon_observation_reference, sovon_MRI, me, veld) %>%
  head(n = 50)
```

MRI is 0 for observations of birds without any ring, thus linked to actions `meweg` (metal ring missing) and `klweg` (color ring missing):

```{r MRI_0_meweg}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_MRI = ifelse(!is.na(meweg) & !is.na(klweg), 0 , sovon_MRI))
```

Preview of changes:

```{r preview_changes_MRI_0}
obs_and_acts %>%
  filter(sovon_MRI == 0) %>%
  select(sovon_observation_reference, sovon_MRI, me, veld) %>%
  head(n = 50)
```

The actions `vang` and  `vangl` related to a change of color ring can be found by checking the date of the observations without action `rgnkl` or `rngme` and with same date of `bird_date_begin` in `crbirding_birds`:

```{r vang_with_change_color_ring}
obs_ref_MRI_5 <- 
  obs_and_acts %>%
  filter((!is.na(vang) | !is.na(vangl)) & is.na(rngkl) & is.na(rngme)) %>%
  inner_join(crbirding_birds %>%
               select(bird_reference, bird_date_begin),
             by = c("sovon_bird_reference" = "bird_reference",
                    "sovon_observation_date" = "bird_date_begin")) %>%
  arrange(sovon_bird_reference, sovon_observation_date) %>%
  pull(sovon_observation_reference)

obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_MRI = ifelse(sovon_observation_reference %in% obs_ref_MRI_5, 
                            5, 
                            sovon_MRI)
)
```

We can now assign value 4 to the other observations with action `vang`:

```{r vang_without_change_color_ring}
vang_no_change_color_ring <- 
  obs_and_acts %>%
  filter((!is.na(vang) | !is.na(vangl)) & is.na(rngkl) & is.na(rngme)) %>%
  filter(!sovon_observation_reference %in% obs_ref_MRI_5) %>%
  pull(sovon_observation_reference)

obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_MRI = ifelse(
    sovon_observation_reference %in% vang_no_change_color_ring, 4, sovon_MRI
    )
)
```

The mapping of MRI related to observations with action `vang` is completed:

```{r MRI_vang}
obs_and_acts %>%
  filter(!is.na(vang)) %>%
  select(sovon_bird_reference, 
         sovon_observation_reference, 
         sovon_MRI, 
         vang) %>%
  arrange(sovon_bird_reference, 
         sovon_observation_reference)
```

Same for observations with actions  `vangl`:

```{r MRI_vangl}
obs_and_acts %>%
  filter(!is.na(vangl)) %>%
  select(sovon_bird_reference, 
         sovon_observation_reference, 
         sovon_MRI, 
         vangl) %>%
  arrange(sovon_bird_reference, 
         sovon_observation_reference)
```

Check that no observations with action `vang` or `vangl` are left without a MRI value:

```{r check_mapping_MRI_vang}
obs_and_acts %>%
  filter(!is.na(vang) | !is.na(vangl)) %>%
  filter(is.na(sovon_MRI)) %>%
  nrow()
```

Action combinations without MRI:

```{r check_obs_without_MRI}
obs_and_acts %>%
  filter(is.na(sovon_MRI)) %>%
  select(acts) %>%
  distinct()
```

### Mapping of INBO actions to status, condition and MRI

The fields  `sovon_status`, `sovon_condition` and `sovon_MRI` should cover all possible action combinations present in observations. Consequently, no observations should have all three fields empty:

```{r check_no_NA_MRI_status_condition}
obs_and_acts %>%
  filter(is.na(sovon_MRI) & is.na(sovon_condition) & is.na(sovon_status)) %>%
  nrow()
```

General mapping of all action combinations present in observations:

```{r combinations_actions_MRI_cond_status}
obs_and_acts %>%
  select(acts, sovon_status, sovon_condition, sovon_MRI) %>%
  distinct()
```

### Bird age ringing

The required field `bird_age_ringing` should be filled with the age of the bird while ringing. 

We first add the age of ringing to observations with same date of applying a ring from  `crbirding_birds`:

```{r add_bird_age_ringing_for_ringing_obs}
obs_ringing <- 
  obs_and_acts %>%
  left_join(crbirding_birds %>%
              select(bird_reference, bird_date_begin, bird_age_ringing),
            by = c("sovon_bird_reference" = "bird_reference",
                   "sovon_observation_date" = "bird_date_begin")) %>%
  filter(!is.na(bird_age_ringing)) %>%
  select(sovon_bird_reference, 
         sovon_observation_date,
         bird_age_ringing) %>%
  rename(age_ringing = bird_age_ringing,
         date_ringing = sovon_observation_date)
```

```{r}
obs_ringing %>% head()
```

The age while ringing can be added to observations occurring later than the very first ringing: 

```{r obs_after_ringing}
obs_after_ringing <- 
  obs_and_acts %>%
  left_join(obs_ringing,
            by = c("sovon_bird_reference")) %>%
  group_by(sovon_bird_reference, sovon_observation_date) %>%
  filter(sovon_observation_date >= date_ringing) %>%
  filter(date_ringing == max(date_ringing)) %>%
  distinct() %>%
  ungroup() %>%
  mutate(sovon_bird_age_ringing = age_ringing) %>%
  select(-c(date_ringing, age_ringing))
```

Otherwise it will be left empty:

```{r obs_before_ringing}
obs_before_ringing <- 
  obs_and_acts %>%
  anti_join(obs_after_ringing,
            by = names(obs_and_acts)) %>%
  mutate(sovon_bird_age_ringing = as.POSIXct(NA))
obs_before_ringing %>% 
  select(sovon_bird_reference, ) %>%
  head(n = 10)
```

Merge the two subsets back together:

```{r merge_back_obs_togeheter}
obs_and_acts <-
  bind_rows(obs_after_ringing, obs_before_ringing) %>%
  arrange(sovon_observation_reference)
```

### Bird sex

The field `sovon_bird_sex` is equal to the bird sex in ring data:

```{r add_sovon_bird_sex_obs}
obs_and_acts <- 
  obs_and_acts %>%
  left_join(crbirding_birds %>% 
              select(bird_reference, bird_sex),
            by = c("sovon_bird_reference" = "bird_reference")) %>%
  rename(sovon_bird_sex = bird_sex)
```

### Capture

The field `sovon_observation_is_capture` can be filled by evaluating the link of observations to actions `vang` or `vangl`:

```{r is_capture}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_observation_is_capture = if_else(
    !is.na(vang) | !is.na(vangl), 1, 0
  )
)
```

### Bird ID

The field `sovon_bird_id` is left to SOVON:

```{r add_bird_id}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_bird_id = NA)
```


### Observation notes

We copy the notes in `Opmerking` to SOVON field  `sovon_observation_notes`:

```{r obs_notes}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(sovon_observation_notes = Opmerking)
```

We add a dot at the end of the notes if not present already:

```{r}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(
    sovon_observation_notes = 
      if_else(
        !is.na(sovon_observation_notes) & str_length(sovon_observation_notes) > 0,
        if_else(str_sub(sovon_observation_notes, -1) != ".",
                str_c(sovon_observation_notes, ".", sep = ""),
                sovon_observation_notes),
        sovon_observation_notes)
)
```

We also add the prefix `"INBO original notes: "`:

```{r add_prefix}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(
    sovon_observation_notes = 
      if_else(
        !is.na(sovon_observation_notes) & str_length(sovon_observation_notes) > 0,
        str_c("INBO original notes: ", sovon_observation_notes, sep = " "),
        sovon_observation_notes)
)
```

We add the note `no_color_ring.` to observations linked to action `klweg`:

```{r add_note_no_color_ring}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(
    sovon_observation_notes = if_else(
      !is.na(klweg),
      if_else(is.na(sovon_observation_notes),
              "no_color_ring.",
              paste("no_color_ring.", sovon_observation_notes, sep = " ")),
      sovon_observation_notes)
)
```

Preview:

```{r no_color_ring_example}
obs_and_acts %>%
  filter(!is.na(klweg)) %>%
  select(sovon_observation_notes) %>%
  head()
```

We add the note `color_ring_added.` to observations linked to action `rngkl`:

```{r add_note_color_ring_added}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(
    sovon_observation_notes = if_else(
      !is.na(rngkl),
      if_else(is.na(sovon_observation_notes),
              "color_ring_added.",
              paste("color_ring_added.", sovon_observation_notes, sep = " ")),
      sovon_observation_notes)
)
```

Preview:

```{r add_color_ring_example}
obs_and_acts %>%
  filter(!is.na(rngkl)) %>%
  select(sovon_observation_notes) %>%
  head()
```

## Save final observation data

Select the required columns, starting with prefix `sovon_`:

```{r select_sovoin_cols}
crbirding_observations <-
  obs_and_acts %>%
  select(starts_with("sovon"))
```

Remove prefix `sovon_`:

```{r remove prefix_sovon_observations}
names(crbirding_observations) <- str_remove_all(names(crbirding_observations), pattern = "sovon_")
```


The desired order of columns in `crbirding_observations`:

```{r cols_order_obs}
cr_obs_cols <- c(
  "user_id", "user_reference", "bird_id", "bird_reference", "observation_id",
  "observation_reference", "observation_date", "observation_time", 
  "observation_lat", "observation_lng", "observation_location", 
  "observation_is_capture", "observation_notes", "check_bird", "MRI", "melder",
  "melder_email", "melder_ringersnummer", "ring_number", "condition", "status", 
  "bird_age_ringing", "bird_sex"
)
```

Are all required columns present?

```{r check_presence_required_cols_obs}
all(cr_obs_cols %in% names(crbirding_observations)) & 
  length(cr_obs_cols) == ncol(crbirding_observations)
```

Set column order:

```{r get_right_order_cols_obs}
crbirding_observations <-
  crbirding_observations %>%
  select(cr_obs_cols)
```

Preview data (without personal observer data for privcay reasons):

```{r final_preview_obs}
crbirding_observations %>% 
  select(-c(melder, melder_email)) %>%
  head(n = 10)
```

Save to text file (tab separated value):

```{r write_processed_obs_data}
write_csv(
  crbirding_observations, 
  path = here::here("data", "processed", "crbirding_observations.tsv"), 
  na = ""
)
```
