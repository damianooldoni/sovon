# Map observation data

## Read data

### Read temporary observation data

We start from the tempoary observation data saved as TSV file in `data\interim`:

```{r import_temp_observations}
obs_and_acts <- read_tsv(
  here::here("data", "interim", "obs_and_actions.tsv"), 
  col_types = cols(
    .default = col_character(),
    sovon_bird_reference = col_double(),
    Nummer = col_double(),
    Datum = col_datetime(format = ""),
    WaarnemerNummer = col_double(),
    PlaatsLengtegraadGraden = col_double(),
    PlaatsLengtegraadMinuten = col_double(),
    PlaatsLengtegraadSeconden = col_double(),
    PlaatsBreedtegraadGraden = col_double(),
    PlaatsBreedtegraadMinuten = col_double(),
    PlaatsBreedtegraadSeconden = col_double(),
    BevestigingDatum = col_datetime(format = ""),
    AanmaakDatum = col_datetime(format = ""),
    WijzigDatum = col_datetime(format = ""))
)
```

### Read action data

Import action codes and relative meaning:

```{r import_actions_meaning2}
actions_meaning <- read_tsv(here::here("data", "input", "actions_meaning.tsv"))
```

### Read processed ring data

We import finalized ring data from `./data/processed`:

```{r import_final_ring_data}
crbirding_birds <- read_tsv(
  here::here("data", "processed", "crbirding_birds.csv"), 
  col_types = cols(
    .default = col_character(),
    bird_id = col_logical(),
    bird_reference = col_double(),
    bird_bto = col_logical(),
    bird_birth_year = col_logical(),
    bird_date_begin = col_datetime(format = "%d-%m-%Y"),
    bird_date_end = col_datetime(format = "%d-%m-%Y"))
)
```

### Read temporary ring data

We will need some columns from original INBO ring data. We import the temporary ring data as well:

```{r import_birds_from_INBO_temp_data}
birds <- read_tsv(
  here::here("data", "interim", "birds.tsv"), 
  col_types = cols(
    .default = col_character())
)
```

### Read ring position data

We import mapping of ring position and inscription reading direction:

```{r read_updated_ring_position_table}
ring_position_table <- read_tsv(
  here::here("data", "interim", "ring_position_table.tsv"),
  na = "",
  col_types = cols(
    .default = col_character(),
    Aktief = col_logical())
)
```

### Read processed user data

We import finalized user data from `./data/processed`:

```{r import_final_user_data}
crbirding_users <- read_tsv(
  here::here("data", "processed", "crbirding_users.csv"), 
  col_types = cols(
    .default = col_character(),
    user_id = col_logical(),
    user_reference = col_double())
)
```

### Read list workers in bird shelters

```{r import_workers}
workers_bird_shelters <- read_tsv(
  here::here("data", "input", "workers_in_bird_shelters.tsv"),
    col_types = cols(
    .default = col_character(),
    user_id = col_logical(),
    user_reference = col_double())
)
```

## Map color observation data

### Extract action codes

Actions present in `obs_and_acts` :

```{r}
acts <- actions_meaning$Code
acts <- acts[acts %in% names(obs_and_acts)]
acts
```

Combinations of actions present in observations:

```{r act_combinations}
action_combinations <- 
  obs_and_acts %>%
  select(acts) %>%
  distinct()
action_combinations
```

### Observation ID

The field `sovon_observation_id` is left to SOVON:

```{r add_obs_id}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_observation_id = NA)
```

### Observation reference

The observation reference is an unique identifier assigned to each observation. This field exists already: `Nummer`.

```{r add_obs_ref}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(sovon_observation_reference = Nummer)
```

### Observation date

The date is saved in column `Datum`. We copy it in required column `sovon_observation_date`:

```{r obs_date}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(sovon_observation_date = Datum)
```

### Observation time

There is no observation time in `obs_and_acts`. `NA` is given to `sovon_observation_time`:

```{r obs_time}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(sovon_observation_time = NA)
```

### Observation latitude

Observation latitude should be converted to decimal degrees:

```{r obs_latitude}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(
    sovon_observation_lat = conv_unit(
      str_c(PlaatsBreedtegraadGraden,
            PlaatsBreedtegraadMinuten,
            PlaatsBreedtegraadSeconden, 
            sep = " "), 
      from = 'deg_min_sec', to = 'dec_deg')
)
```

### Observation longitude

Observation longitude should be converted to decimal degrees:

```{r obs_longitude}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(
    sovon_observation_lng = conv_unit(
      str_c(PlaatsLengtegraadGraden,
            PlaatsLengtegraadMinuten,
            PlaatsLengtegraadSeconden, 
            sep = " "), 
      from = 'deg_min_sec', to = 'dec_deg')
)
```

### Observation location

Aggregate information about observation location. We follow the following structure: `PlaatsGemeente` [+ `, ` + `PlaatsToponym` [+ `: ` + `PlaatsToponymDetail`]]:

```{r obs_location}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(
    sovon_observation_location = ifelse(!is.na(PlaatsToponym),
                                  str_c(PlaatsGemeente,
                                        PlaatsToponym, 
                                        sep = ", "),
                                  paste(PlaatsGemeente))) %>%
  mutate(
    sovon_observation_location = ifelse(!is.na(PlaatsToponymDetail),
                                  str_c(sovon_observation_location,
                                        PlaatsToponymDetail,
                                        sep = ": "),
                                  paste(sovon_observation_location)))
```

### Check bird

The field `sovon_check_bird` is provided by SOVON. `NA` is given:

```{r check_bird}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_check_bird = NA)
```

### User ID

The field `sovon_user_id` is left to SOVON:

```{r add_user_id}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_user_id = NA)
```


### User reference

The field `sovon_user_reference` links observations to users and it is equal to field `user_reference` in user data:

```{r add_user_reference}
obs_and_acts <-
  obs_and_acts %>%
  mutate(sovon_user_reference = WaarnemerNummer)
```

### Observer

The field `sovon_melder` is equal to `user_first_name` and `user_last_name` in `users`:

```{r obs_sovon_melder}
obs_and_acts <- 
  obs_and_acts %>%
  left_join(
    crbirding_users %>% 
      select(user_reference, user_first_name, user_last_name),
    by = c("WaarnemerNummer" = "user_reference")) %>%
  mutate(sovon_melder = case_when(
    is.na(user_first_name) & !is.na(user_last_name) ~ user_last_name,
    !is.na(user_first_name) & is.na(user_last_name) ~ user_first_name,
    !is.na(user_first_name) & !is.na(user_last_name) ~ str_c(user_first_name, user_last_name, sep = " "),
    is.na(user_first_name) & is.na(user_last_name) ~ NA_character_)) %>%
  select(-c(user_first_name, user_last_name))
```

### Observer e-mail

The field `sovon_melder_email` is equal to `user_email` in `users`:

```{r obs_sovon_melder_email}
obs_and_acts <- 
  obs_and_acts %>%
  left_join(
    crbirding_users %>% 
      select(user_reference, user_email),
    by = c("WaarnemerNummer" = "user_reference")) %>%
  mutate(sovon_melder_email = user_email)
```

### Reporter - ringer number

The field `sovon_melder_ringersnummer` is left to SOVON:

```{r sovon_melder_ringersnummer}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_melder_ringersnummer = NA)
```

### Ring number

The field `sovon_ring_number` contains information about the metal ring number, in the same format as in field `bird_ring_number` of `crbirding_birds`. As explained in the mapping of field `bird_ring_number` of `crbirding_birds`, INBO database is a color ring database. This field is not accurately mapped and we will leave it empty.

```{r add_ring_number}
obs_and_acts <-
  obs_and_acts %>%
  mutate(sovon_ring_number = NA_character_)
```

### Observation status

Adding the EURING status information arises by the need of mapping the observations with action code `br` and `vang`:

```{r breed_show}
actions_meaning %>%
  filter(Code %in% c("br", "vang"))
```

The actions `br` and `vang` refer to status `breeding` in EURING system. Based on the scheme at page 16 of [EURING Exchange Code 2000+](https://euring.org/files/documents/E2000PLUSExchangeCodev1161.pdf) document, we define the following mapping:

```{r obs_status}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_status = case_when(
    !is.na(br) | !is.na(vang) ~ "N",
    LeeftijdCode == "PU" ~ "-",
    TRUE ~ "U"
  ))
```

### Condition

The SOVON field `condition` is mapped following the scheme at page 22 of [EURING Exchange Code 2000+](https://euring.org/files/documents/E2000PLUSExchangeCodev1161.pdf) document. The following actions are mapped as follows in order of priority:

1. `dood`: condition = 1
2. `ziek`: condition = 4
3. `rngkl`, `rngme`, `vang`, `vangl`: condition = 8
4. `veld`, `me`, `meweg`, `klweg`, `br`: condition = 7

```{r obs_condition}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_condition = case_when(
    dood == "dood" ~ 1,
    klgev == "klgev" ~ 1,
    ziek == "ziek" ~ 4,
    !is.na(rngkl) | !is.na(rngme) | !is.na(vang) | !is.na(vangl)  ~ 8,
    !is.na(veld) | !is.na(me) | !is.na(meweg) | !is.na(klweg) | !is.na(br)  ~ 7
    )
)
```

The observations of sick birds not anymore released should get condition equal to 5. These observations are linked to the very last `ziek` action and followed by an observation with action `dood`. Not only, but the observer should be a worker of a bird shelter, in `workers_bird_shelters`.

Reference number of observations with condition 5:

```{r get_obs_cond_5}
last_sick_df <- 
  obs_and_acts %>%
  filter(sovon_melder_ringersnummer %in% workers_bird_shelters$user_reference) %>%
  filter(ziek == "ziek") %>%
  group_by(sovon_bird_reference) %>%
  filter(sovon_observation_date == max(sovon_observation_date)) %>%
  ungroup() %>%
  select(sovon_observation_reference, sovon_bird_reference, sovon_observation_date) %>%
  rename(last_sick_date = sovon_observation_date,
         obs_ref = sovon_observation_reference)
dead_df <-
  obs_and_acts %>%
  filter(dood == "dood") %>%
  select(sovon_bird_reference, sovon_observation_date) %>%
  rename(dead_date = sovon_observation_date)
last_sick_df <- 
  last_sick_df %>%
  filter(sovon_bird_reference %in% dead_df$sovon_bird_reference) %>%
  left_join(dead_df, by = "sovon_bird_reference")

condition_5_obs_ref <- 
  obs_and_acts %>%
  filter(sovon_bird_reference %in% last_sick_df$sovon_bird_reference) %>%
  left_join(last_sick_df,
            by = "sovon_bird_reference") %>%
  group_by(sovon_bird_reference) %>%
  filter(sovon_observation_date >= last_sick_date & 
           sovon_observation_date < dead_date) %>%
  count() %>%
  ## only one ziek action present -> no obs possible if not released
  filter(n == 1) %>%
  left_join(last_sick_df,
            by = c("sovon_bird_reference")) %>%
  pull(obs_ref)
```

Number of observations selected to get condition code 5:

```{r n_obs_condition_5}
length(condition_5_obs_ref)
```

Assign condition value `5` to these observations:

```{r assign_5}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_condition = 
           if_else(
             sovon_observation_reference %in% condition_5_obs_ref, 
             5,
             sovon_condition)
)
```

Preview:

```{r preview}
obs_and_acts %>%
  filter(sovon_condition == 5) %>%
  select(sovon_observation_reference, 
         sovon_bird_reference, 
         sovon_observation_date,
         acts)
```

### MRI: metal ring information

Metal ring information is an integer between 0 and 9. A table can be found at page 8 of [EURING Exchange Code 2000+](https://euring.org/files/documents/E2000PLUSExchangeCodev1161.pdf) document.

However, SOVON uses this field to map the observations referring to the applying of any kind of ring, either color or metal, as their database is purely focussed on color rings and due to a missing field in the EURING Exchange Code 2000+ specific for color rings.

INBO experts explained us that all color rings are applied on tarsus, MRI: 2, while metal ring position is on tarsus or above or unknown, MRI: 1. However, the value 2 is not allowed by SOVON (see [comment in issue 47](https://github.com/inbo/cr-birding/issues/47#issuecomment-478926426)). Values allowed: 1, 4 and 5, where 4 is used for adding a color and/or metal ring, while 5 for changing

Mapping decision rules:

1. Default: MRI 4 
2. Very first ringing of a bird (no matter if `rngme` only, `rngkl` only or  `rngme` +  `rngkl`): `MRI` 1
3. Changing a metal and/or color ring: MRI 5

This last condition holds true even if the color ring is changed while adding a metal ring or viceversa.

We initialize `sovon_MRI` by assigning default value 4:

```{r initialize_MRI_obs_and_acts}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_MRI = 4)
```

Very first ringing gets `sovon_MRI` = 1:

```{r assign_1_to_very_first_ringing}
obs_and_acts <- 
  obs_and_acts %>%
  group_by(sovon_bird_reference) %>%
  mutate(sovon_MRI = if_else(
    Datum == min(Datum) & (rngkl == "rngkl" | rngme == "rngme"), 
    1, sovon_MRI)) %>%
  arrange(sovon_bird_reference, Datum) %>%
  ungroup()
```

Adding a color ring while metal ring is alrady present is mapped as 4, which is the default value. Same for adding a metal ring while color ring already present.


Based on `crbirding_birds` MRI is 5 if previous **`bird_shorthand` is not empty and different from actual `bird_shorthand`**.
As said in previous chapter while mapping ring data, we don't have track of changing metal rings, only loosing it (actions `meweg`).  We then assume to add a new one. So, MRI value 5 depends only on value of `bird_shorthand` as only color rings can be changed in our mapping.

```{r map_5_change_color_rings}
MRI_5_bird_ref_and_dates <- 
  crbirding_birds %>%
  group_by(bird_reference) %>%
  mutate(previous_bird_shorthand = lag(bird_shorthand)) %>%
  filter(!is.na(previous_bird_shorthand) & 
           previous_bird_shorthand != bird_shorthand) %>%
  select(bird_reference, bird_date_begin) %>%
  ungroup() %>%
  mutate(set_MRI_5 = 5)
obs_and_acts <- 
  obs_and_acts %>%
  left_join(MRI_5_bird_ref_and_dates,
            by = c("sovon_bird_reference" = "bird_reference", 
                   "Datum" = "bird_date_begin")) %>%
  mutate(sovon_MRI = if_else(!is.na(set_MRI_5), set_MRI_5, sovon_MRI))
```

### Bird age

The field `sovon_bird_age_obs` should be filled with the age of the bird as mentioned by the observer. This field has been created in previous chapter:

```{r mapping_bird_age_ringing}
obs_and_acts %>%
  distinct(sovon_bird_age_obs)
```

### Bird sex

The field `sovon_bird_sex` should be filled with the sex of the bird as mentioned by the observer. This field is not present in `obs_and_acts`, so we assign value `U` (unknown):

```{r add_sovon_bird_sex_obs}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_bird_sex = "U")
```

### Capture

The field `sovon_observation_is_capture` can be filled by evaluating the link of observations to actions `vang`, `vangl`, `rngkl` or `rngme`:

```{r is_capture}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_observation_is_capture = if_else(
    !is.na(vang) | !is.na(vangl) | !is.na(rngkl) | !is.na(rngme), "Y", "N"
  )
)
```

### Bird ID

The field `sovon_bird_id` is left to SOVON:

```{r add_bird_id}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_bird_id = NA)
```

### Bird ring position and inscription direction

Similarly to the mapping in ring data, we map the ring position and inscription reading direction in observations:

```{r map_pos_direction_obs}
obs_and_acts <- 
  obs_and_acts %>% 
  left_join(ring_position_table %>%
              select(Code, sovon_bird_ring_position),
            by = c("KleurringPlaats" = "Code")) %>%
  left_join(ring_position_table %>%
              select(Code, sovon_bird_ring_direction),
            by = c("KleurringPlaats" = "Code"))
```

Effects of the mapping:

```{r result_mapping_position_direction_obs}
obs_and_acts %>%
  distinct(KleurringPlaats, sovon_bird_ring_position, sovon_bird_ring_direction)
```

### Observation notes

We copy the notes in `Opmerking` to SOVON field  `sovon_observation_notes`:

```{r obs_notes}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(sovon_observation_notes = Opmerking)
```

We add a dot at the end of the notes if not present already:

```{r}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(
    sovon_observation_notes = 
      if_else(
        !is.na(sovon_observation_notes) & str_length(sovon_observation_notes) > 0,
        if_else(str_sub(sovon_observation_notes, -1) != ".",
                str_c(sovon_observation_notes, ".", sep = ""),
                sovon_observation_notes),
        sovon_observation_notes)
)
```

We also add the prefix `"INBO original notes: "`:

```{r add_prefix}
obs_and_acts <- 
  obs_and_acts %>% 
  mutate(
    sovon_observation_notes = 
      if_else(
        !is.na(sovon_observation_notes) & str_length(sovon_observation_notes) > 0,
        str_c("INBO original notes: ", sovon_observation_notes, sep = " "),
        sovon_observation_notes)
)
```

We add the note `no_color_ring.` to observations linked to action `klweg` and/or `me`:

```{r add_note_no_color_ring}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(
    sovon_observation_notes = if_else(
      klweg == "klweg" | me == "me",
      if_else(is.na(sovon_observation_notes),
              "no_color_ring.",
              paste("no_color_ring.", sovon_observation_notes, sep = " ")),
      sovon_observation_notes)
)
```

Preview:

```{r no_color_ring_example}
obs_and_acts %>%
  filter(!is.na(klweg)) %>%
  select(sovon_observation_notes) %>%
  head()
```

We add the note `no_metal_ring.` to observations linked to action `meweg`:

```{r add_note_no_metal_ring}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(
    sovon_observation_notes = if_else(
      !is.na(meweg),
      if_else(is.na(sovon_observation_notes),
              "no_metal_ring.",
              paste("no_metal_ring.", sovon_observation_notes, sep = " ")),
      sovon_observation_notes)
)
```

Preview:

```{r no_metal_ring_example}
obs_and_acts %>%
  filter(!is.na(meweg)) %>%
  select(sovon_observation_notes) %>%
  head()
```

## Save final observation data

Transform date from ISO standard yyyy-mm-dd to SOVON's standard dd-mm-yyyy:

```{r transform_date_dd-mm-yyyy_observation_date}
obs_and_acts <- 
  obs_and_acts %>%
  mutate(sovon_observation_date = as.character(sovon_observation_date, 
                                               format = "%d-%m-%Y")
)
```

Select the required columns, starting with prefix `sovon_`:

```{r select_sovon_cols}
crbirding_observations <-
  obs_and_acts %>%
  select(starts_with("sovon"))
```

Remove prefix `sovon_`:

```{r remove prefix_sovon_observations}
names(crbirding_observations) <- str_remove_all(names(crbirding_observations), pattern = "sovon_")
```

The desired order of columns in `crbirding_observations`:

```{r cols_order_obs}
cr_obs_cols <- c(
  "user_id", "user_reference", "bird_id", "bird_reference", "observation_id",
  "observation_reference", "observation_date", "observation_time", 
  "observation_lat", "observation_lng", "observation_location", 
  "observation_is_capture", "observation_notes", "check_bird", "MRI", "melder",
  "melder_email", "melder_ringersnummer", "ring_number", "condition", "status", 
  "bird_age_obs", "bird_sex", "bird_ring_position", "bird_ring_direction"
)
```

Are all required columns present?

```{r check_presence_required_cols_obs}
all(cr_obs_cols %in% names(crbirding_observations)) & 
  length(cr_obs_cols) == ncol(crbirding_observations)
```

Set column order:

```{r get_right_order_cols_obs}
crbirding_observations <-
  crbirding_observations %>%
  select(cr_obs_cols)
```

Preview data (without personal observer data for privcay reasons):

```{r final_preview_obs}
crbirding_observations %>% 
  select(-c(melder, melder_email)) %>%
  head(n = 10)
```

Save to text file (comma separated value):

```{r write_processed_obs_data}
write_csv(
  crbirding_observations, 
  path = here::here("data", "processed", "crbirding_observations.csv"), 
  na = ""
)
```
